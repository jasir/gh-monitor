#!/bin/bash

# GitHub Actions Monitor Script
# Sleduje stav GitHub Action run a notifikuje pÅ™i dokonÄenÃ­

set -e

# Barvy pro output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m' # No Color

# Funkce pro zobrazenÃ­ nÃ¡povÄ›dy
show_help() {
    echo "GitHub Actions Monitor"
    echo ""
    echo "Usage: $0 <run_id> [options]"
    echo ""
    echo "Parametry:"
    echo "  run_id              ID GitHub Action run (povinnÃ©)"
    echo ""
    echo "Volby:"
    echo "  -r, --repo REPO     Repository ve formÃ¡tu owner/repo (vÃ½chozÃ­: aktuÃ¡lnÃ­ repo)"
    echo "  -i, --interval SEC  Interval kontroly v sekundÃ¡ch (vÃ½chozÃ­: 10)"
    echo "  -t, --timeout MIN   Timeout v minutÃ¡ch (vÃ½chozÃ­: 60)"
    echo "  -q, --quiet         TichÃ½ reÅ¾im - pouze koneÄnÃ¡ notifikace"
    echo "  -h, --help          ZobrazÃ­ tuto nÃ¡povÄ›du"
    echo ""
    echo "PÅ™Ã­klady:"
    echo "  $0 16648023936"
    echo "  $0 16648023936 --repo KosikGroup/web-frontend"
    echo "  $0 16648023936 --interval 10 --timeout 120"
}

# Funkce pro notifikaci
notify() {
    local title="$1"
    local message="$2"
    local urgency="${3:-normal}"
    local url="${4:-}"
    
    echo ""
    echo "ğŸ”” ========================================"
    echo "   $title"
    echo "   $message"
    if [[ -n "$url" ]]; then
        echo "   ğŸ”— $url"
    fi
    echo "========================================"
    echo ""
    
    # Desktop notifikace - vÅ¾dy se pokusÃ­ odeslat
    if command -v notify-send >/dev/null 2>&1 && [[ -n "$DISPLAY" ]]; then
        # OdebrÃ¡nÃ­ escape sekvencÃ­ pro ÄistÃ½ text v notifikaci
        local clean_message=$(echo -e "$message" | sed 's/\\033\[[0-9;]*m//g')
        
        # PÅ™idÃ¡nÃ­ URL do notifikace pokud existuje
        if [[ -n "$url" ]]; then
            clean_message="$clean_message\n\nğŸ”— Zobrazit: $url"
        fi
        
        # Persistent notifikace pro critical a completion
        if [[ "$urgency" == "critical" ]] || [[ "$urgency" == "completion" ]]; then
            if notify-send -t 0 -u "critical" "$title" "$clean_message" 2>/dev/null; then
                echo "ğŸ“± Persistent notifikace odeslÃ¡na (vyÅ¾aduje ruÄnÃ­ zavÅ™enÃ­)"
            else
                echo "âš ï¸  Desktop notifikace nedostupnÃ¡ (nenÃ­ GUI prostÅ™edÃ­)"
            fi
        else
            if notify-send -t 5000 -u "$urgency" "$title" "$clean_message" 2>/dev/null; then
                echo "ğŸ“± Desktop notifikace odeslÃ¡na"
            else
                echo "âš ï¸  Desktop notifikace nedostupnÃ¡ (nenÃ­ GUI prostÅ™edÃ­)"
            fi
        fi
    else
        echo "âš ï¸  Desktop notifikace nedostupnÃ¡ (chybÃ­ notify-send nebo DISPLAY)"
    fi
    
    # Audio signÃ¡l pro dokonÄenÃ­
    if [[ "$urgency" == "critical" ]] && command -v paplay >/dev/null 2>&1; then
        paplay /usr/share/sounds/alsa/Front_Left.wav 2>/dev/null || true
    elif [[ "$urgency" == "critical" ]] && command -v beep >/dev/null 2>&1; then
        beep -f 800 -l 300 2>/dev/null || true
    fi
}

# Funkce pro zÃ­skÃ¡nÃ­ stavu run
get_run_status() {
    local run_id="$1"
    local repo="$2"
    
    if [[ -n "$repo" ]]; then
        gh run view "$run_id" --repo "$repo" --json status,conclusion,name,createdAt,url,jobs
    else
        gh run view "$run_id" --json status,conclusion,name,createdAt,url,jobs
    fi
}

# Funkce pro zobrazenÃ­ aktuÃ¡lnÃ­ch jobÅ¯
show_current_jobs() {
    local jobs_json="$1"
    local max_jobs=3
    
    if [[ "$jobs_json" == "null" ]] || [[ -z "$jobs_json" ]]; then
        return
    fi
    
    # Najdi bÄ›Å¾Ã­cÃ­ joby
    local running_jobs=$(echo "$jobs_json" | jq -r '.[] | select(.status == "in_progress") | .name')
    # Najdi joby ve frontÄ›
    local queued_jobs=$(echo "$jobs_json" | jq -r '.[] | select(.status == "queued") | .name')
    
    if [[ -n "$running_jobs" ]]; then
        echo -e "   ${BLUE}ğŸ”„ BÄ›Å¾Ã­cÃ­ kroky:${NC}"
        echo "$running_jobs" | head -$max_jobs | while read -r job; do
            [[ -n "$job" ]] && echo "     â€¢ $job"
        done
        
        local running_count=$(echo "$running_jobs" | wc -l)
        if [[ $running_count -gt $max_jobs ]]; then
            echo "     ... a dalÅ¡Ã­ch $((running_count - max_jobs)) krokÅ¯"
        fi
    fi
    
    if [[ -n "$queued_jobs" ]]; then
        echo -e "   ${YELLOW}â³ Ve frontÄ›:${NC}"
        echo "$queued_jobs" | head -2 | while read -r job; do
            [[ -n "$job" ]] && echo "     â€¢ $job"
        done
        
        local queued_count=$(echo "$queued_jobs" | wc -l)
        if [[ $queued_count -gt 2 ]]; then
            echo "     ... a dalÅ¡Ã­ch $((queued_count - 2)) krokÅ¯"
        fi
    fi
}

# Funkce pro zobrazenÃ­ stavu
show_status() {
    local status="$1"
    local conclusion="$2"
    local name="$3"
    local run_id="$4"
    local elapsed="$5"
    local jobs_json="$6"
    
    case "$status" in
        "completed")
            case "$conclusion" in
                "success")
                    echo -e "${GREEN}âœ… DOKONÄŒENO - ÃšSPÄšCH${NC}"
                    ;;
                "failure")
                    echo -e "${RED}âŒ DOKONÄŒENO - CHYBA${NC}"
                    ;;
                "cancelled")
                    echo -e "${YELLOW}ğŸš« DOKONÄŒENO - ZRUÅ ENO${NC}"
                    ;;
                *)
                    echo -e "${YELLOW}âš ï¸  DOKONÄŒENO - $conclusion${NC}"
                    ;;
            esac
            ;;
        "in_progress")
            echo -e "${BLUE}ğŸ”„ BÄšÅ½Ã${NC}"
            ;;
        "queued")
            echo -e "${YELLOW}â³ VE FRONTÄš${NC}"
            ;;
        "waiting")
            echo -e "${RED}â¸ï¸  ÄŒEKÃ NA AKCI UÅ½IVATELE${NC}"
            ;;
        *)
            echo -e "${YELLOW}â“ NEZNÃMÃ STAV: $status${NC}"
            ;;
    esac
    
    echo "   Workflow: $name"
    echo "   Run ID: $run_id"
    echo "   UplynulÃ½ Äas: $(format_time $elapsed)"
    
    # Zobraz aktuÃ¡lnÃ­ kroky pokud workflow bÄ›Å¾Ã­ nebo ÄekÃ¡
    if [[ "$status" == "in_progress" ]] || [[ "$status" == "queued" ]] || [[ "$status" == "waiting" ]]; then
        show_current_jobs "$jobs_json"
    fi
}

# Funkce pro formÃ¡tovÃ¡nÃ­ Äasu
format_time() {
    local seconds=$1
    local hours=$((seconds / 3600))
    local minutes=$(((seconds % 3600) / 60))
    local secs=$((seconds % 60))
    
    if [[ $hours -gt 0 ]]; then
        printf "%dh %dm %ds" $hours $minutes $secs
    elif [[ $minutes -gt 0 ]]; then
        printf "%dm %ds" $minutes $secs
    else
        printf "%ds" $secs
    fi
}

# HlavnÃ­ funkce
main() {
    local run_id=""
    local repo=""
    local interval=10
    local timeout=3600  # 60 minut v sekundÃ¡ch
    local quiet=false
    
    # ParsovÃ¡nÃ­ argumentÅ¯
    while [[ $# -gt 0 ]]; do
        case $1 in
            -h|--help)
                show_help
                exit 0
                ;;
            -r|--repo)
                repo="$2"
                shift 2
                ;;
            -i|--interval)
                interval="$2"
                shift 2
                ;;
            -t|--timeout)
                timeout=$((${2} * 60))  # pÅ™evod na sekundy
                shift 2
                ;;
            -q|--quiet)
                quiet=true
                shift
                ;;
            *)
                if [[ -z "$run_id" ]]; then
                    run_id="$1"
                else
                    echo "NeznÃ¡mÃ½ parametr: $1"
                    exit 1
                fi
                shift
                ;;
        esac
    done
    
    # Kontrola povinnÃ½ch parametrÅ¯
    if [[ -z "$run_id" ]]; then
        echo "Chyba: MusÃ­te zadat run_id"
        echo ""
        show_help
        exit 1
    fi
    
    # OvÄ›Å™enÃ­, Å¾e gh je dostupnÃ©
    if ! command -v gh >/dev/null 2>&1; then
        echo "Chyba: GitHub CLI (gh) nenÃ­ nainstalovanÃ©"
        exit 1
    fi
    
    # OvÄ›Å™enÃ­, Å¾e jq je dostupnÃ©
    if ! command -v jq >/dev/null 2>&1; then
        echo "Chyba: jq nenÃ­ nainstalovanÃ© (potÅ™ebnÃ© pro parsovÃ¡nÃ­ JSON)"
        echo "Nainstalujte: sudo apt install jq"
        exit 1
    fi
    
    # OvÄ›Å™enÃ­ autentifikace
    if ! gh auth status >/dev/null 2>&1; then
        echo "Chyba: Nejste pÅ™ihlÃ¡Å¡eni do GitHub CLI"
        echo "SpusÅ¥te: gh auth login"
        exit 1
    fi
    
    echo "ğŸš€ SpouÅ¡tÃ­m sledovÃ¡nÃ­ GitHub Action run..."
    echo "   Run ID: $run_id"
    [[ -n "$repo" ]] && echo "   Repository: $repo"
    echo "   Interval: ${interval}s"
    echo "   Timeout: $(format_time $timeout)"
    echo ""
    
    local start_time=$(date +%s)
    local check_count=0
    
    while true; do
        local current_time=$(date +%s)
        local elapsed=$((current_time - start_time))
        
        # Kontrola timeout
        if [[ $elapsed -gt $timeout ]]; then
            notify "GitHub Action Timeout" "SledovÃ¡nÃ­ run $run_id bylo ukonÄeno kvÅ¯li timeout" "critical"
            exit 1
        fi
        
        check_count=$((check_count + 1))
        
        # ZÃ­skÃ¡nÃ­ stavu
        local status_json
        if ! status_json=$(get_run_status "$run_id" "$repo" 2>/dev/null); then
            echo "âŒ Chyba pÅ™i zÃ­skÃ¡vÃ¡nÃ­ stavu run $run_id"
            sleep $interval
            continue
        fi
        
        local status=$(echo "$status_json" | jq -r '.status')
        local conclusion=$(echo "$status_json" | jq -r '.conclusion // "null"')
        local name=$(echo "$status_json" | jq -r '.name')
        local url=$(echo "$status_json" | jq -r '.url')
        local jobs_json=$(echo "$status_json" | jq -r '.jobs')
        
        # ZobrazenÃ­ stavu (pokud nenÃ­ tichÃ½ reÅ¾im)
        if [[ "$quiet" == false ]]; then
            echo "ğŸ“Š Kontrola #$check_count ($(date '+%H:%M:%S'))"
            show_status "$status" "$conclusion" "$name" "$run_id" "$elapsed" "$jobs_json"
            echo ""
        fi
        
        # Kontrola zmÄ›ny stavu z waiting
        if [[ "$status" != "waiting" ]] && [[ -f "/tmp/gh-monitor-${run_id}-waiting" ]]; then
            rm -f "/tmp/gh-monitor-${run_id}-waiting"
            notify "ğŸ”” GitHub Action pokraÄuje" "Workflow: <b>$name</b>\nZmÄ›na ze stavu ÄekÃ¡nÃ­\nRun ID: $run_id" "normal" "$url"
        elif [[ "$status" == "waiting" ]] && [[ ! -f "/tmp/gh-monitor-${run_id}-waiting" ]]; then
            touch "/tmp/gh-monitor-${run_id}-waiting"
            notify "â¸ï¸ GitHub Action ÄekÃ¡" "Workflow: <b>$name</b>\nPotÅ™ebuje akci uÅ¾ivatele\nRun ID: $run_id" "critical" "$url"
        fi
        
        # Kontrola, zda je run dokonÄen
        if [[ "$status" == "completed" ]]; then
            local duration=$(format_time $elapsed)
            
            case "$conclusion" in
                "success")
                    local title="âœ… GitHub Action ÃšSPÄšÅ NÃ"
                    local message="Workflow: <b>$name</b>\nDoba bÄ›hu: <i>$duration</i>\nRun ID: $run_id"
                    notify "$title" "$message" "completion" "$url"
                    echo "ğŸ‰ Workflow dokonÄena ÃºspÄ›Å¡nÄ›!"
                    exit 0
                    ;;
                "failure")
                    local title="âŒ GitHub Action SELHALA"
                    local message="Workflow: <b>$name</b>\nDoba bÄ›hu: <i>$duration</i>\nRun ID: $run_id"
                    notify "$title" "$message" "completion" "$url"
                    echo "ğŸ’¥ Workflow selhala!"
                    echo "ğŸ”— Zobrazit na GitHubu: $url"
                    exit 1
                    ;;
                "cancelled")
                    local title="ğŸš« GitHub Action ZRUÅ ENA"
                    local message="Workflow: <b>$name</b>\nDoba bÄ›hu: <i>$duration</i>\nRun ID: $run_id"
                    notify "$title" "$message" "completion" "$url"
                    echo "â¹ï¸  Workflow byla zruÅ¡ena"
                    exit 2
                    ;;
                *)
                    local title="âš ï¸ GitHub Action dokonÄena"
                    local message="Workflow: <b>$name</b>\nStav: <u>$conclusion</u>\nDoba bÄ›hu: <i>$duration</i>\nRun ID: $run_id"
                    notify "$title" "$message" "completion" "$url"
                    echo "â“ Workflow dokonÄena s neoÄekÃ¡vanÃ½m stavem: $conclusion"
                    exit 3
                    ;;
            esac
        fi
        
        # ÄŒekÃ¡nÃ­ pÅ™ed dalÅ¡Ã­ kontrolou
        sleep $interval
    done
}

# SpuÅ¡tÄ›nÃ­ hlavnÃ­ funkce
main "$@"